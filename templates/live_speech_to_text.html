{% extends "base.html" %}

{% block content %}
<section>
    <h2>Live Speech Translation</h2>
    <p>Click "Start" and speak into your microphone. The transcription and translation will appear below in real-time.</p>
    <button id="start-btn">Start</button>
    <button id="stop-btn" disabled>Stop</button>
    <div>
        <label for="language-select">Translate to:</label>
        <select id="language-select">
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="it">Italian</option>
            <option value="pt">Portuguese</option>
            <option value="hi">Hindi</option>
            <option value="bn">Bengali</option>
            <option value="gu">Gujarati</option>
            <option value="kn">Kannada</option>
            <option value="ml">Malayalam</option>
            <option value="mr">Marathi</option>
            <option value="or">Odia</option>
            <option value="pa">Punjabi</option>
            <option value="ta">Tamil</option>
            <option value="te">Telugu</option>
            <option value="ur">Urdu</option>
            <option value="ja">Japanese</option>
            <option value="ko">Korean</option>
            <option value="zh-cn">Chinese (Simplified)</option>
        </select>
    </div>
    <p><strong>Transcription:</strong></p>
    <div id="transcription" style="border:1px solid #ccc; padding:10px; min-height:100px;"></div>
    <p><strong>Translation:</strong></p>
    <div id="translation" style="border:1px solid #ccc; padding:10px; min-height:100px;"></div>
    <h3>Translated Audio:</h3>
    <div id="audio-output"></div>
</section>

<script>
let mediaRecorder;
let audioChunks = [];
let isRecording = false;

const startBtn = document.getElementById('start-btn');
const stopBtn = document.getElementById('stop-btn');
const transcriptionDiv = document.getElementById('transcription');
const translationDiv = document.getElementById('translation');
const langSelect = document.getElementById('language-select');
const audioOutput = document.getElementById('audio-output');

startBtn.onclick = async () => {
    if (isRecording) return;
    isRecording = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    transcriptionDiv.textContent = '';
    translationDiv.textContent = '';
    audioOutput.innerHTML = '';

    // Add recording animation class to start button
    startBtn.classList.add('recording');

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
    };

    mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        audioChunks = [];

        const formData = new FormData();
        formData.append('audio_data', audioBlob, 'recording.webm');
        formData.append('language', langSelect.value);

        const response = await fetch('/live-speech-translation', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const data = await response.json();
            transcriptionDiv.textContent = data.transcription;
            translationDiv.textContent = data.translation;
            if (data.audio_file) {
                const audio = new Audio(data.audio_file);
                audio.controls = true;
                audioOutput.appendChild(audio);
            }
        } else {
            transcriptionDiv.textContent = 'Error processing audio.';
        }

        // Remove recording animation class from start button
        startBtn.classList.remove('recording');
    };

    mediaRecorder.start();
};

stopBtn.onclick = () => {
    if (!isRecording) return;
    isRecording = false;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    mediaRecorder.stop();
};
</script>
{% endblock %}